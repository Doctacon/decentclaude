#!/bin/bash
#
# query-explain - Explains BigQuery query execution plans
#
# Usage:
#   query-explain "SELECT * FROM project.dataset.table LIMIT 10"
#   query-explain --file query.sql
#
# Description:
#   This command validates a BigQuery SQL query and provides detailed execution
#   plan information including cost estimates. It helps understand query performance
#   and resource usage before execution.
#
# Requirements:
#   - BigQuery MCP tools configured in Claude Code
#   - Access to BigQuery project
#
# Output:
#   - Query validation status
#   - Estimated bytes processed
#   - Cost estimation (at $5 per TB)
#   - Query complexity analysis
#

set -euo pipefail

# Color codes for output formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help message
show_help() {
    cat << EOF
Usage: query-explain [OPTIONS] QUERY

Explains BigQuery query execution plans and cost estimates.

OPTIONS:
    -f, --file FILE     Read query from file instead of command line
    -h, --help          Show this help message

ARGUMENTS:
    QUERY              SQL query string to analyze

EXAMPLES:
    # Analyze inline query
    query-explain "SELECT * FROM \`project.dataset.table\` LIMIT 10"

    # Analyze query from file
    query-explain --file queries/complex_join.sql

    # Pipe query to command
    cat query.sql | query-explain -f -

EOF
}

# Parse arguments
QUERY=""
FILE_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -f|--file)
            FILE_MODE=true
            if [[ "${2:-}" == "-" ]]; then
                # Read from stdin
                QUERY=$(cat)
                shift
            elif [[ -f "${2:-}" ]]; then
                QUERY=$(cat "$2")
                shift 2
            else
                echo -e "${RED}Error: File not found: ${2:-}${NC}" >&2
                exit 1
            fi
            ;;
        *)
            if [[ -z "$QUERY" ]]; then
                QUERY="$1"
                shift
            else
                echo -e "${RED}Error: Multiple queries provided${NC}" >&2
                show_help
                exit 1
            fi
            ;;
    esac
done

# Check if query is provided
if [[ -z "$QUERY" ]]; then
    echo -e "${RED}Error: No query provided${NC}" >&2
    show_help
    exit 1
fi

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}BigQuery Query Analysis${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Display the query
echo -e "${YELLOW}Query:${NC}"
echo "$QUERY"
echo ""

# Step 1: Validate the query
echo -e "${BLUE}Step 1: Validating query syntax...${NC}"
VALIDATION_PROMPT="Validate this BigQuery SQL query using the validate_sql tool: $QUERY"

# Call Claude with BigQuery MCP to validate
# In Claude Code, this would invoke the MCP tool
echo "Please use the BigQuery MCP validate_sql tool to validate this query."
echo ""

# Step 2: Estimate query cost
echo -e "${BLUE}Step 2: Estimating query cost...${NC}"
COST_PROMPT="Estimate the cost of this BigQuery query using the estimate_query_cost tool: $QUERY"

echo "Please use the BigQuery MCP estimate_query_cost tool to get the bytes that will be processed."
echo ""

# Step 3: Provide analysis
echo -e "${BLUE}Step 3: Query analysis...${NC}"
ANALYSIS_PROMPT="Analyze this BigQuery query for performance optimization opportunities and provide recommendations: $QUERY"

echo "Please analyze this query and provide:"
echo "  - Estimated cost (at \$5 per TB)"
echo "  - Query complexity assessment"
echo "  - Performance optimization suggestions"
echo "  - Potential issues or warnings"
echo ""

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Analysis complete!${NC}"
echo -e "${GREEN}========================================${NC}"

# Exit successfully
exit 0
