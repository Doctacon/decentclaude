#!/usr/bin/env bash
#
# data-quality-audit - Comprehensive data quality assessment workflow
#
# This workflow orchestrates bq-profile, data quality checks, and reporting
# to provide a complete data quality audit for a BigQuery table.
#
# Usage:
#   ./workflows/data-quality-audit <table_id> [quality_threshold]
#
# Arguments:
#   table_id           BigQuery table ID (project.dataset.table)
#   quality_threshold  Minimum acceptable quality score 0-100 (default: 80)
#
# Example:
#   ./workflows/data-quality-audit myproject.analytics.users 85
#
# Output:
#   - JSON profile report
#   - Data quality metrics
#   - Pass/fail status
#   - Recommendations for improvements
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="$SCRIPT_DIR/../bin/data-utils"
THRESHOLD="${2:-80}"
TABLE_ID="$1"

if [ -z "$TABLE_ID" ]; then
    echo "Usage: $0 <table_id> [quality_threshold]"
    echo "Example: $0 myproject.dataset.table 85"
    exit 1
fi

# Create output directory
OUTPUT_DIR="data-quality-reports"
mkdir -p "$OUTPUT_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="$OUTPUT_DIR/${TABLE_ID//[.\/]/_}_${TIMESTAMP}.json"

echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  Data Quality Audit${NC}"
echo -e "${BLUE}  Table: $TABLE_ID${NC}"
echo -e "${BLUE}  Threshold: $THRESHOLD%${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo

# Step 1: Profile the table
echo -e "${YELLOW}[Step 1/4]${NC} Profiling table..."
if ! "$BIN_DIR/bq-profile" "$TABLE_ID" --format=json --detect-anomalies > "$REPORT_FILE"; then
    echo -e "${RED}✗ FAILED${NC}: Could not profile table"
    exit 1
fi
echo -e "${GREEN}✓ COMPLETE${NC}"
echo

# Step 2: Analyze data quality metrics
echo -e "${YELLOW}[Step 2/4]${NC} Analyzing data quality..."

# Extract metrics from profile
NULL_PCT=$(jq -r '.null_percentages | if . then [.[] | select(. != null)] | add / length else 0 end' "$REPORT_FILE" 2>/dev/null || echo "0")
DISTINCT_RATIO=$(jq -r '.distinctness_ratio // 0' "$REPORT_FILE" 2>/dev/null || echo "0")
ANOMALY_COUNT=$(jq -r '.anomalies | if . then length else 0 end' "$REPORT_FILE" 2>/dev/null || echo "0")

# Calculate quality score (0-100)
# - Lower null percentage is better (weight: 40%)
# - Higher distinct ratio is better for non-dimension tables (weight: 30%)
# - Fewer anomalies is better (weight: 30%)
NULL_SCORE=$(echo "scale=2; (100 - $NULL_PCT)" | bc)
DISTINCT_SCORE=$(echo "scale=2; $DISTINCT_RATIO * 100" | bc)
ANOMALY_SCORE=$(echo "scale=2; if ($ANOMALY_COUNT > 10) 0 else (10 - $ANOMALY_COUNT) * 10" | bc)

QUALITY_SCORE=$(echo "scale=2; ($NULL_SCORE * 0.4) + ($DISTINCT_SCORE * 0.3) + ($ANOMALY_SCORE * 0.3)" | bc)

echo "  Null percentage: ${NULL_PCT}%"
echo "  Distinctness ratio: ${DISTINCT_RATIO}"
echo "  Anomalies detected: ${ANOMALY_COUNT}"
echo "  Quality score: ${QUALITY_SCORE}/100"
echo -e "${GREEN}✓ COMPLETE${NC}"
echo

# Step 3: Generate recommendations
echo -e "${YELLOW}[Step 3/4]${NC} Generating recommendations..."
RECOMMENDATIONS=()

if (( $(echo "$NULL_PCT > 20" | bc -l) )); then
    RECOMMENDATIONS+=("High null percentage detected. Consider adding NOT NULL constraints or default values.")
fi

if (( $(echo "$DISTINCT_RATIO < 0.01" | bc -l) )); then
    RECOMMENDATIONS+=("Low distinctness detected. This may be expected for dimension tables, but verify data isn't duplicated.")
fi

if (( ANOMALY_COUNT > 5 )); then
    RECOMMENDATIONS+=("Multiple anomalies detected. Review the 'anomalies' section in the report for details.")
fi

if [ ${#RECOMMENDATIONS[@]} -eq 0 ]; then
    echo "  No issues found - data quality looks good!"
else
    for rec in "${RECOMMENDATIONS[@]}"; do
        echo "  - $rec"
    done
fi
echo -e "${GREEN}✓ COMPLETE${NC}"
echo

# Step 4: Pass/Fail determination
echo -e "${YELLOW}[Step 4/4]${NC} Determining pass/fail status..."
if (( $(echo "$QUALITY_SCORE >= $THRESHOLD" | bc -l) )); then
    echo -e "${GREEN}✓ PASS${NC}: Quality score ${QUALITY_SCORE}% meets threshold ${THRESHOLD}%"
    RESULT="PASS"
    EXIT_CODE=0
else
    echo -e "${RED}✗ FAIL${NC}: Quality score ${QUALITY_SCORE}% below threshold ${THRESHOLD}%"
    RESULT="FAIL"
    EXIT_CODE=1
fi
echo

# Add summary to report
jq --arg score "$QUALITY_SCORE" \
   --arg threshold "$THRESHOLD" \
   --arg result "$RESULT" \
   --argjson recommendations "$(printf '%s\n' "${RECOMMENDATIONS[@]}" | jq -R . | jq -s .)" \
   '. + {quality_score: ($score | tonumber), quality_threshold: ($threshold | tonumber), result: $result, recommendations: $recommendations}' \
   "$REPORT_FILE" > "${REPORT_FILE}.tmp" && mv "${REPORT_FILE}.tmp" "$REPORT_FILE"

echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  Audit Complete${NC}"
echo -e "${BLUE}  Report saved to: $REPORT_FILE${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════${NC}"

exit $EXIT_CODE
