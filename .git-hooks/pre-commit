#!/usr/bin/env bash
# pre-commit hook - Run before git commit
#
# This hook:
#   - Validates that we're not committing on a branch checked out elsewhere
#   - Warns about large uncommitted changes in other worktrees
#   - Updates worktree activity timestamp

set -euo pipefail

# Get current branch and worktree
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
CURRENT_WORKTREE=$(git rev-parse --show-toplevel)

# Skip if on detached HEAD
if [[ "$CURRENT_BRANCH" == "HEAD" ]]; then
    exit 0
fi

# Check for other worktrees on the same branch
while IFS= read -r line; do
    if [[ $line =~ ^worktree[[:space:]]+(.*) ]]; then
        WORKTREE_PATH="${BASH_REMATCH[1]}"

        # Skip current worktree and bare repos
        if [[ "$WORKTREE_PATH" == "$CURRENT_WORKTREE" ]] || [[ $WORKTREE_PATH == *".repo.git"* ]]; then
            continue
        fi

        # Get branch info
        read -r branch_line
        if [[ $branch_line =~ branch[[:space:]]+refs/heads/(.*) ]]; then
            BRANCH="${BASH_REMATCH[1]}"

            if [[ "$BRANCH" == "$CURRENT_BRANCH" ]]; then
                echo "Error: Branch '$CURRENT_BRANCH' is checked out in another worktree:"
                echo "  $WORKTREE_PATH"
                echo ""
                echo "Committing on a branch that is checked out in multiple worktrees"
                echo "can cause confusion and conflicts. Please switch one of them to a"
                echo "different branch before committing."
                echo ""
                echo "To override this check, use: git commit --no-verify"
                exit 1
            fi
        fi
    fi
done < <(git worktree list --porcelain)

# Update last commit timestamp for this worktree
WORKTREE_STATE_DIR="${GIT_DIR:-$(git rev-parse --git-common-dir)}/worktree-state"
mkdir -p "$WORKTREE_STATE_DIR"
date +%s > "$WORKTREE_STATE_DIR/$(basename "$CURRENT_WORKTREE").last_commit"

exit 0
