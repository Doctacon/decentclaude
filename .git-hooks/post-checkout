#!/usr/bin/env bash
# post-checkout hook - Run after git checkout
#
# This hook:
#   - Updates worktree status file
#   - Notifies about uncommitted changes in other worktrees on the same branch
#   - Warns if the branch is already checked out in another worktree

set -euo pipefail

# Arguments: previous_head new_head branch_checkout_flag
PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_CHECKOUT=$3

# Only run for branch checkouts
if [[ $BRANCH_CHECKOUT -ne 1 ]]; then
    exit 0
fi

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Skip if on detached HEAD
if [[ "$CURRENT_BRANCH" == "HEAD" ]]; then
    exit 0
fi

# Get current worktree path
CURRENT_WORKTREE=$(git rev-parse --show-toplevel)

# Check for other worktrees on the same branch
WORKTREE_CONFLICT=false
while IFS= read -r line; do
    if [[ $line =~ ^worktree[[:space:]]+(.*) ]]; then
        WORKTREE_PATH="${BASH_REMATCH[1]}"

        # Skip current worktree and bare repos
        if [[ "$WORKTREE_PATH" == "$CURRENT_WORKTREE" ]] || [[ $WORKTREE_PATH == *".repo.git"* ]]; then
            continue
        fi

        # Get branch info
        read -r branch_line
        if [[ $branch_line =~ branch[[:space:]]+refs/heads/(.*) ]]; then
            BRANCH="${BASH_REMATCH[1]}"

            if [[ "$BRANCH" == "$CURRENT_BRANCH" ]]; then
                echo "Warning: Branch '$CURRENT_BRANCH' is also checked out in:"
                echo "  $WORKTREE_PATH"
                echo ""
                echo "This can cause issues with git operations. Consider using a different branch."
                WORKTREE_CONFLICT=true
            fi
        fi
    fi
done < <(git worktree list --porcelain)

# Update last checkout timestamp for this worktree
WORKTREE_STATE_DIR="${GIT_DIR:-$(git rev-parse --git-common-dir)}/worktree-state"
mkdir -p "$WORKTREE_STATE_DIR"
date +%s > "$WORKTREE_STATE_DIR/$(basename "$CURRENT_WORKTREE").last_checkout"

exit 0
