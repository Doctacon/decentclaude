#!/usr/bin/env bash
# wt-sync - Sync common state and fetch updates across all worktrees
#
# Usage: wt-sync [options]
#
# This utility:
#   - Fetches latest changes from remote
#   - Prunes deleted remote branches
#   - Updates worktree status file
#   - Reports any worktrees that need attention
#
# Options:
#   --prune-merged, -p   Remove worktrees for merged branches
#   --dry-run, -n        Show what would be done without doing it
#   --help, -h           Show this help message

set -euo pipefail

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Options
PRUNE_MERGED=false
DRY_RUN=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--prune-merged)
            PRUNE_MERGED=true
            shift
            ;;
        -n|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            grep '^#' "$0" | sed 's/^# \?//'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo -e "${CYAN}Syncing worktrees...${RESET}"
echo ""

# Step 1: Fetch from remote
echo -e "${CYAN}[1/3] Fetching from remote${RESET}"
if $DRY_RUN; then
    echo "  (dry-run) Would run: git fetch --all --prune"
else
    git fetch --all --prune
    echo -e "  ${GREEN}✓ Fetch complete${RESET}"
fi
echo ""

# Step 2: Check each worktree
echo -e "${CYAN}[2/3] Checking worktree status${RESET}"
WORKTREES_NEEDING_ATTENTION=()

while IFS= read -r line; do
    if [[ $line =~ ^worktree[[:space:]]+(.*) ]]; then
        WORKTREE_PATH="${BASH_REMATCH[1]}"

        # Skip bare repos
        if [[ $WORKTREE_PATH == *".repo.git"* ]]; then
            continue
        fi

        # Get branch info
        read -r branch_line
        if [[ $branch_line =~ branch[[:space:]]+refs/heads/(.*) ]]; then
            BRANCH="${BASH_REMATCH[1]}"
        else
            continue
        fi

        cd "$WORKTREE_PATH" 2>/dev/null || continue

        WORKTREE_NAME=$(basename "$WORKTREE_PATH")

        # Check for uncommitted changes
        if [[ -n $(git status --porcelain) ]]; then
            echo -e "  ${YELLOW}⚠ $WORKTREE_NAME${RESET} - has uncommitted changes"
            WORKTREES_NEEDING_ATTENTION+=("$WORKTREE_NAME (uncommitted changes)")
            continue
        fi

        # Check if branch is merged
        if $PRUNE_MERGED; then
            # Check if branch exists on remote
            if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
                # Check if merged into main
                if git merge-base --is-ancestor "$BRANCH" "origin/main" 2>/dev/null; then
                    echo -e "  ${GREEN}✓ $WORKTREE_NAME${RESET} - branch merged into main"
                    if $DRY_RUN; then
                        echo "    (dry-run) Would remove worktree"
                    else
                        echo "    Removing worktree..."
                        cd ..
                        git worktree remove "$WORKTREE_PATH" 2>/dev/null || echo "    Failed to remove (may need manual cleanup)"
                    fi
                    continue
                fi
            fi
        fi

        # Check ahead/behind status
        AHEAD_BEHIND=$(git rev-list --left-right --count @{upstream}...HEAD 2>/dev/null || echo "0	0")
        BEHIND=$(echo "$AHEAD_BEHIND" | cut -f1)
        AHEAD=$(echo "$AHEAD_BEHIND" | cut -f2)

        if [[ $BEHIND -gt 0 ]]; then
            echo -e "  ${YELLOW}⚠ $WORKTREE_NAME${RESET} - behind origin by $BEHIND commits"
            WORKTREES_NEEDING_ATTENTION+=("$WORKTREE_NAME (behind by $BEHIND)")
        elif [[ $AHEAD -gt 0 ]]; then
            echo -e "  ${CYAN}ℹ $WORKTREE_NAME${RESET} - ahead of origin by $AHEAD commits"
        else
            echo -e "  ${GREEN}✓ $WORKTREE_NAME${RESET} - up to date"
        fi
    fi
done < <(git worktree list --porcelain)
echo ""

# Step 3: Summary
echo -e "${CYAN}[3/3] Summary${RESET}"
if [[ ${#WORKTREES_NEEDING_ATTENTION[@]} -eq 0 ]]; then
    echo -e "  ${GREEN}All worktrees are in sync${RESET}"
else
    echo -e "  ${YELLOW}Worktrees needing attention:${RESET}"
    for worktree in "${WORKTREES_NEEDING_ATTENTION[@]}"; do
        echo "    - $worktree"
    done
fi
echo ""
echo -e "${GREEN}Sync complete${RESET}"
