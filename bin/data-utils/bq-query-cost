#!/usr/bin/env python3
"""
bq-query-cost - Estimate BigQuery query cost before execution

Usage:
  bq-query-cost <query> [options]
  bq-query-cost --file=<sql_file> [options]

Arguments:
  query      SQL query to estimate (use quotes for multi-line)

Options:
  --file=<path>      Read query from SQL file
  --format=<format>  Output format: text, json (default: text)
  --help, -h         Show this help message

Examples:
  bq-query-cost "SELECT * FROM project.dataset.table WHERE date = '2024-01-01'"
  bq-query-cost --file=query.sql
  bq-query-cost --file=query.sql --format=json
"""

import sys
import json
import argparse
from pathlib import Path
from google.cloud import bigquery


class Colors:
    """ANSI color codes for terminal output"""
    RED = '\033[0;31m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    BLUE = '\033[0;34m'
    CYAN = '\033[0;36m'
    RESET = '\033[0m'
    BOLD = '\033[1m'


def estimate_query_cost(client: bigquery.Client, query: str) -> dict:
    """
    Estimate the cost of a BigQuery query using dry run.

    Args:
        client: BigQuery client
        query: SQL query to estimate

    Returns:
        Dictionary with cost estimation details
    """
    try:
        # Configure dry run job
        job_config = bigquery.QueryJobConfig(dry_run=True, use_query_cache=False)

        # Run dry run query
        query_job = client.query(query, job_config=job_config)

        # Get bytes to process
        bytes_processed = query_job.total_bytes_processed
        gb_processed = bytes_processed / (1024 ** 3)
        tb_processed = bytes_processed / (1024 ** 4)

        # Calculate cost (on-demand pricing: $6.25 per TB)
        # First 1 TB per month is free, but we show gross cost
        cost_per_tb = 6.25
        estimated_cost = tb_processed * cost_per_tb

        return {
            "bytes_processed": bytes_processed,
            "gb_processed": gb_processed,
            "tb_processed": tb_processed,
            "estimated_cost_usd": estimated_cost,
            "pricing_model": "on-demand",
            "cost_per_tb": cost_per_tb,
            "query": query
        }

    except Exception as e:
        print(f"{Colors.RED}Error estimating query cost: {str(e)}{Colors.RESET}", file=sys.stderr)
        sys.exit(1)


def format_bytes(bytes_value: int) -> str:
    """Format bytes into human-readable string"""
    for unit in ['B', 'KB', 'MB', 'GB', 'TB', 'PB']:
        if bytes_value < 1024.0:
            return f"{bytes_value:.2f} {unit}"
        bytes_value /= 1024.0
    return f"{bytes_value:.2f} EB"


def get_cost_category(cost_usd: float) -> tuple:
    """Get cost category and color based on estimated cost"""
    if cost_usd < 0.01:
        return "Very Low", Colors.GREEN
    elif cost_usd < 0.10:
        return "Low", Colors.GREEN
    elif cost_usd < 1.00:
        return "Moderate", Colors.YELLOW
    elif cost_usd < 10.00:
        return "High", Colors.YELLOW
    else:
        return "Very High", Colors.RED


def print_text_report(result: dict):
    """Print a formatted text report of cost estimation"""

    cost_category, cost_color = get_cost_category(result['estimated_cost_usd'])

    print(f"\n{Colors.CYAN}{Colors.BOLD}BigQuery Query Cost Estimation{Colors.RESET}")
    print("=" * 80)

    print(f"\n{Colors.BOLD}Data Processed:{Colors.RESET}")
    print(f"  Bytes:     {result['bytes_processed']:,}")
    print(f"  Human:     {format_bytes(result['bytes_processed'])}")
    print(f"  GB:        {result['gb_processed']:.4f}")
    print(f"  TB:        {result['tb_processed']:.6f}")

    print(f"\n{Colors.BOLD}Cost Estimate:{Colors.RESET}")
    print(f"  Pricing:   {result['pricing_model']} (${result['cost_per_tb']:.2f}/TB)")
    print(f"  Cost:      {cost_color}${result['estimated_cost_usd']:.4f} USD{Colors.RESET}")
    print(f"  Category:  {cost_color}{cost_category}{Colors.RESET}")

    print(f"\n{Colors.BOLD}Notes:{Colors.RESET}")
    print("  • First 1 TB per month is free (on-demand pricing)")
    print("  • Cached query results are free")
    print("  • Flat-rate customers are not charged per query")
    print("  • Actual cost may vary based on your billing model")

    print(f"\n{Colors.BOLD}Query Preview:{Colors.RESET}")
    query_lines = result['query'].strip().split('\n')
    preview_lines = query_lines[:5]
    for line in preview_lines:
        print(f"  {line}")
    if len(query_lines) > 5:
        print(f"  ... ({len(query_lines) - 5} more lines)")

    print("\n" + "=" * 80)


def print_json_report(result: dict):
    """Print a JSON report of cost estimation"""
    output = {
        "bytes_processed": result['bytes_processed'],
        "gb_processed": round(result['gb_processed'], 4),
        "tb_processed": round(result['tb_processed'], 6),
        "estimated_cost_usd": round(result['estimated_cost_usd'], 4),
        "human_readable": format_bytes(result['bytes_processed']),
        "pricing_model": result['pricing_model'],
        "cost_per_tb": result['cost_per_tb'],
        "category": get_cost_category(result['estimated_cost_usd'])[0].lower().replace(' ', '_')
    }
    print(json.dumps(output, indent=2))


def main():
    parser = argparse.ArgumentParser(
        description="Estimate BigQuery query cost before execution",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__
    )
    parser.add_argument("query", nargs="?", help="SQL query to estimate")
    parser.add_argument("--file", help="Read query from SQL file")
    parser.add_argument("--format", choices=["text", "json"], default="text",
                       help="Output format (default: text)")

    args = parser.parse_args()

    # Get query from argument or file
    if args.file:
        try:
            query = Path(args.file).read_text()
        except Exception as e:
            print(f"{Colors.RED}Error reading file {args.file}: {str(e)}{Colors.RESET}", file=sys.stderr)
            sys.exit(1)
    elif args.query:
        query = args.query
    else:
        parser.print_help()
        sys.exit(1)

    # Initialize BigQuery client
    client = bigquery.Client()

    # Estimate query cost
    result = estimate_query_cost(client, query)

    # Print report
    if args.format == "json":
        print_json_report(result)
    else:
        print_text_report(result)


if __name__ == "__main__":
    main()
